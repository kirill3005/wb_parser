from __future__ import annotations

"""
Набор промпт-шаблонов для типичных RAG-задач под олимпиадный формат.

Идея:
- Каждый промпт описывает ЗАДАЧУ и ТРЕБУЕМЫЙ ФОРМАТ (обычно JSON).
- Конкретные поля JSON лучше дополнительно описывать через schema_hint,
  когда ты вызываешь llm.generate_json(...).
- Здесь только текстовая логика: что модель должна делать с вопросом и контекстом.

Переменные, которые обычно подставляются через .format(...):

- {question}           — текст вопроса (QA / summarization).
- {context}            — склеенный контекст (выбранные чанки).
- {claim}              — утверждение для fact-check.
- {schema_description} — текстовое описание JSON-схемы, если оно нужно.
- {labels}             — строка с перечислением допустимых меток/классов.
- {topic}              — тема (для таймлайна и т.п.).
"""

# ======================================================================
# 1. QA по корпусу с цитатами (короткий ответ + индексы чанков)
# ======================================================================

QA_WITH_CITATIONS_PROMPT = """
Ты отвечаешь на вопрос по данному контексту.

Требования:
- Отвечай кратко и по делу, одной-двумя фразами.
- Опирайся только на переданный контекст.
- Если информации в контексте недостаточно, честно так и скажи в поле "answer".
- Обязательно верни индексы чанков, на которые ты опирался.

Формат ответа — строго JSON:
{{
  "answer": "строка с кратким ответом (или 'unknown', если ответа нет в контексте)",
  "citations": [список целых чисел, индексы чанков]
}}

Примеры допустимых ответов (просто как формат):

{{
  "answer": "Закон Ома связывает ток, напряжение и сопротивление.",
  "citations": [3, 10]
}}

{{
  "answer": "unknown",
  "citations": []
}}

Вопрос:
{question}

Контекст:
{context}
""".strip()


# ======================================================================
# 2. Fact-check: supports / refutes / not_enough_info + цитаты
# ======================================================================

FACT_CHECK_PROMPT = """
Тебе дано утверждение и контекст (фрагменты корпуса).

Твоя задача:
1. На основе контекста определить, как он соотносится с утверждением:
   - "supports"  — контекст явно подтверждает утверждение;
   - "refutes"   — контекст явно опровергает утверждение;
   - "not_enough_info" — в контексте не хватает информации, чтобы уверенно подтвердить или опровергнуть.

2. Вернуть индексы чанков, которые служат обоснованием (если таких нет, список может быть пустым).

Требования:
- Используй только переданный контекст, не добавляй внешние знания.
- Будь консервативен: если нет явного подтверждения или опровержения — выбирай "not_enough_info".

Формат ответа — строго JSON:
{{
  "label": "supports | refutes | not_enough_info",
  "citations": [список целых чисел, индексы чанков]
}}

Примеры формата (не содержательно):

{{
  "label": "supports",
  "citations": [7, 11]
}}

{{
  "label": "not_enough_info",
  "citations": []
}}

Утверждение:
{claim}

Контекст:
{context}
""".strip()


# ======================================================================
# 3. Извлечение структурированных сущностей по схеме (JSON-схемы)
# ======================================================================

EXTRACTION_SCHEMA_PROMPT = """
Тебе дан текст (одного или нескольких документов). 
Нужно извлечь структурированную информацию в формате JSON по заданной схеме.

Требования:
- Используй только информацию из переданного контекста.
- Не придумывай значения, которых нет в тексте.
- Если какое-то поле нельзя заполнить — ставь null или пустой список/строку, в зависимости от смысла поля.
- Строго следуй описанию схемы.

Ниже дана текстовая спецификация ожидаемой схемы JSON (это не сам ответ, а описание структуры):

{schema_description}

Верни ТОЛЬКО один JSON-объект, строго следующей этой структуре.

Контекст:
{context}
""".strip()


# ======================================================================
# 4. Query-focused summarization (конспект по вопросу) + цитаты
# ======================================================================

QUERY_SUMMARY_WITH_CITATIONS_PROMPT = """
Тебе дана коллекция фрагментов текста (контекст) и вопрос.
Нужно сделать краткое, сфокусированное на вопросе резюме (конспект).

Требования:
- Отвечай именно на вопрос, а не пересказывай весь текст подряд.
- Используй только переданный контекст.
- Не придумывай факты, которых нет в тексте.
- Укажи, на какие чанки ты опирался.

Формат ответа — строго JSON:
{{
  "summary": "краткий связный текст-ответ на вопрос (несколько предложений)",
  "citations": [список целых чисел, индексы чанков]
}}

Пример формата:

{{
  "summary": "В работе предложен метод ..., который улучшает ... по сравнению с ....",
  "citations": [3, 4, 5]
}}

Вопрос:
{question}

Контекст:
{context}
""".strip()


# ======================================================================
# 5. Timeline / хронология событий по теме
# ======================================================================

TIMELINE_PROMPT = """
Тебе дан корпус фрагментов текста (контекст) по теме.

Нужно построить хронологию (таймлайн) ключевых событий по заданной теме.

Требования:
- Для каждого события постарайся указать год (или более точную дату, если она явно указана).
- Кратко опиши событие.
- Приведи индексы чанков, где это событие описано.
- Не выдумывай даты: если точной даты нет, можно опустить или поставить null.

Формат ответа — строго JSON:
{{
  "topic": "строка с названием темы",
  "timeline": [
    {{
      "year": 1957,
      "date": "1957-10-04",  // можно null, если нет точной даты
      "event": "Краткое описание события",
      "citations": [список индексов чанков]
    }},
    ...
  ]
}}

Если событий нет — верни пустой список в поле "timeline".

Тема:
{topic}

Контекст:
{context}
""".strip()


# ======================================================================
# 6. Классификация документа (+ опциональные цитаты)
# ======================================================================

DOC_CLASSIFICATION_PROMPT = """
Тебе дан текст (или несколько фрагментов одного документа).
Нужно отнести его к одной из заданных категорий.

Требования:
- Классифицируй документ строго в один класс из списка допустимых.
- В поле "label" верни имя класса.
- В поле "citations" верни индексы чанков, на основе которых принято решение (может быть пусто).

Список допустимых классов:
{labels}

Формат ответа — строго JSON:
{{
  "label": "одна из категорий из списка выше",
  "citations": [список целых чисел, индексы чанков]
}}

Контекст:
{context}
""".strip()


# ======================================================================
# 7. Мульти-лейбл классификация (+ цитаты)
# ======================================================================

MULTILABEL_CLASSIFICATION_PROMPT = """
Тебе дан текст (или несколько фрагментов одного документа).
Нужно определить, какие темы/категории из списка затронуты в тексте.

Требования:
- Можно вернуть от 0 до N меток.
- В поле "labels" верни список строк — подмножество допустимых меток.
- В поле "citations" верни индексы чанков, которые лучше всего иллюстрируют выбор меток.

Список допустимых меток:
{labels}

Формат ответа — строго JSON:
{{
  "labels": ["список строк, каждая — метка из списка выше"],
  "citations": [список целых чисел, индексы чанков]
}}

Контекст:
{context}
""".strip()


# ======================================================================
# 8. Объяснение / reasoning поверх уже выбранных чанков
# ======================================================================

EXPLANATION_PROMPT = """
Тебе дан контекст (несколько фрагментов текста), уже отобранный ретривером.

Нужно:
- Кратко объяснить ответ на вопрос, ссылаясь на ключевые факты из контекста.
- Сформулировать объяснение так, чтобы оно было понятным человеку.

Формат ответа — свободный текст (НЕ JSON).
Если информации недостаточно, явно скажи об этом.

Вопрос:
{question}

Контекст:
{context}
""".strip()


__all__ = [
    "QA_WITH_CITATIONS_PROMPT",
    "FACT_CHECK_PROMPT",
    "EXTRACTION_SCHEMA_PROMPT",
    "QUERY_SUMMARY_WITH_CITATIONS_PROMPT",
    "TIMELINE_PROMPT",
    "DOC_CLASSIFICATION_PROMPT",
    "MULTILABEL_CLASSIFICATION_PROMPT",
    "EXPLANATION_PROMPT",
]
